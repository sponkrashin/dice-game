<html>
    <head>
        <script src="http://d3js.org/d3.v3.js"></script>
    <head>


    <body>
        <div style="margin:auto;">
            <table>
                <tr>
                    <td>
                        <p style="font-size:18px;">Размер поля:</p>
                    </td>
                    <td>
                        <select id="size" style="font-size:18px;">
                            <option value="7">7*7</option>
                            <option value="8">8*8</option>
                            <option value="9">9*9</option>
                            <option value="10">10*10</option>
                            <option value="11">11*11</option>
                        </select>
                    <td>
                </tr>
            </table>
        </div>

        <div  style="width:40%; margin: auto;">
            <svg id="canv" style="width:100%; height:100%; margin: auto;"></svg>
        </div>
    </body>

    <script>
        document.addEventListener("DOMContentLoaded", () =>{

            let selecting = false;
            let points = [];
            
            const svg = d3.select("#canv");
            const canvas_width = svg.node().getBoundingClientRect().width;
            let start_point = null;

            function render_field(size){
                rect_side = canvas_width/size
                border = rect_side*0.01;

               //add
                svg.selectAll('rect').data(points).enter().append('rect')
                    .attr('x', function(d) { return d.x*rect_side+d.x*border; })
                    .attr('y', function(d) { return d.y*rect_side+d.y*border; })
                    .attr('height', rect_side)
                    .attr('width', rect_side)
                    .attr('data-point-x', function(d) { return d.x; })
                    .attr('data-point-y', function(d) { return d.y; })
                    .on('mousedown', function() {
                        selecting = true;
                        let rect = d3.select(this);
                        rect.style('fill', 'blue');
                        start_point = { 'x': rect.attr("data-point-x"), 'y': rect.attr("data-point-y")};
                    })
                    .on('mouseup', function() { 
                        start_point = null; 
                        selecting = false; 
                        })
                    .on('mouseover',  function() {
                        if (selecting){
                            const rect = d3.select(this);
                            rect.style('fill', 'blue');
                            set_neighbors(start_point, {'x': rect.attr('data-point-x'), 'y': rect.attr('data-point-y')}, size);
                        }
                    })
                    .transition().duration(1500)
                    .style('fill', 'lightblue');
                    
                svg.selectAll('rect').data(points)
                    .style('fill', function(d) {
                        if (d.sel === true) 
                            return 'blue'; 
                        else 
                            return 'lightblue';
                    });

                svg.selectAll('rect').data(points).exit().remove();
            }

            function set_neighbors(start_point, end_point, size){
                if (start_point == null){
                    alert('end');
                    return;
                }
                const minX = Math.min(start_point.x, end_point.x);
                const minY = Math.min(start_point.y, end_point.y);
                const maxX = Math.max(start_point.x, end_point.x);
                const maxY = Math.max(start_point.y, end_point.y);
                for (let i=0; i<points.length; i++){
                    if (points[i].x <= maxX && points[i].x >= minX &&
                        points[i].y <= maxY && points[i].y >= minY)
                        points[i].sel = true;
                    else
                        points[i].sel = false;
                }
                render_field(size);
            }

            
            document.querySelector("#size").onchange = function() {
                const canvas_size = this.value;
                setPoints(canvas_size);
            }

            function setPoints(size){
                points = [];
                render_field(size);
                 for(let i=0; i<size; i++){
                    for(let j=0; j<size; j++){
                        points.push({'x': i, 'y': j, 'sel': false});
                    }
                }
                render_field(size);
            }

            setPoints(document.querySelector("#size").value)
        })
    </script>
</html>